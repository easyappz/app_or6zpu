openapi: 3.0.3
info:
  title: Classifieds Board API
  version: 1.0.0
  description: |
    Русскоязычное API для доски объявлений: регистрация/авторизация по JWT,
    профиль, категории, объявления, избранное и пагинация.
servers:
  - url: /
tags:
  - name: Auth
    description: Авторизация и регистрация
  - name: Members
    description: Профили пользователей (участников)
  - name: Categories
    description: Категории объявлений
  - name: Ads
    description: Управление объявлениями и поиск
  - name: Utils
    description: Вспомогательные эндпоинты (проверка работы API)
paths:
  /api/hello/:
    get:
      tags: [Utils]
      summary: Проверка API
      description: Возвращает тестовое сообщение и метку времени. Публичный доступ.
      responses:
        '200':
          description: Сообщение об успешной проверке
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Message'
              examples:
                ok:
                  summary: Пример успешного ответа
                  value:
                    message: "Hello!"
                    timestamp: "2025-11-11T10:00:00Z"
  /api/auth/register:
    post:
      tags: [Auth]
      summary: Регистрация нового пользователя
      description: Создаёт участника (Member). Авторизация не требуется.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AuthRegisterRequest'
            examples:
              sample:
                summary: Пример запроса
                value:
                  name: "Иван"
                  email: "ivan@example.com"
                  phone: "+7 900 000-00-00"
                  password: "secret123"
      responses:
        '201':
          description: Пользователь создан
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    description: Сообщение об успешной регистрации
                required: [message]
              examples:
                created:
                  value:
                    message: "Регистрация успешна"
        '400':
          description: Ошибка валидации входных данных
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
              examples:
                email_exists:
                  value:
                    email: ["Пользователь с таким email уже существует."]
  /api/auth/login:
    post:
      tags: [Auth]
      summary: Вход по email и паролю
      description: Возвращает JWT-токен доступа. Авторизация не требуется.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AuthLoginRequest'
            examples:
              sample:
                value:
                  email: "ivan@example.com"
                  password: "secret123"
      responses:
        '200':
          description: Успешная аутентификация
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthTokenResponse'
              examples:
                ok:
                  value:
                    access: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
                    token_type: "bearer"
                    expires_in: 604800
        '400':
          description: Неверные учётные данные или ошибки валидации
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/ValidationError'
                  - $ref: '#/components/schemas/ErrorDetail'
              examples:
                bad_creds:
                  value:
                    non_field_errors: ["Неверный email или пароль."]
  /api/members/me:
    get:
      tags: [Members]
      summary: Текущий профиль
      description: Возвращает данные текущего участника (по токену).
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Данные профиля
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Member'
        '401':
          description: Требуется авторизация
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorDetail'
              examples:
                no_token:
                  value:
                    detail: "Требуется авторизация"
    put:
      tags: [Members]
      summary: Обновить профиль
      description: Обновляет поля профиля текущего участника.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MemberUpdate'
            examples:
              sample:
                value:
                  name: "Иван Петров"
                  phone: "+7 900 111-22-33"
                  avatar_url: "https://example.com/a.png"
      responses:
        '200':
          description: Обновлённый профиль
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Member'
        '400':
          description: Ошибка валидации
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
              examples:
                phone_taken:
                  value:
                    phone: ["Пользователь с таким телефоном уже существует."]
        '401':
          description: Требуется авторизация
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorDetail'
  /api/categories:
    get:
      tags: [Categories]
      summary: Список категорий
      description: Публичный список категорий объявлений.
      responses:
        '200':
          description: Список категорий
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Category'
  /api/categories/{pk}:
    get:
      tags: [Categories]
      summary: Получить категорию
      description: Публичное получение одной категории по ID.
      parameters:
        - in: path
          name: pk
          required: true
          schema: { type: integer }
          description: Идентификатор категории
      responses:
        '200':
          description: Категория
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Category'
        '404':
          description: Не найдено
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorDetail'
              examples:
                not_found:
                  value:
                    detail: "Не найдено"
  /api/ads:
    get:
      tags: [Ads]
      summary: Поиск и список объявлений
      description: Публичный список с пагинацией и фильтрами.
      parameters:
        - in: query
          name: page
          schema: { type: integer, minimum: 1 }
          description: Номер страницы (пагинация)
        - in: query
          name: page_size
          schema: { type: integer, minimum: 1, maximum: 200 }
          description: Размер страницы (количество элементов)
        - in: query
          name: category_id
          schema: { type: integer }
          description: Фильтр по категории
        - in: query
          name: price_min
          schema: { type: string }
          description: Минимальная цена (десятичное число)
        - in: query
          name: price_max
          schema: { type: string }
          description: Максимальная цена (десятичное число)
        - in: query
          name: date_from
          schema: { type: string, format: date }
          description: Показать объявления, созданные начиная с этой даты
        - in: query
          name: date_to
          schema: { type: string, format: date }
          description: Показать объявления, созданные до этой даты (включительно)
        - in: query
          name: location
          schema: { type: string }
          description: Фильтр по местоположению (строка)
        - in: query
          name: q
          schema: { type: string }
          description: Поиск по ключевым словам (заголовок/описание)
        - in: query
          name: ordering
          schema:
            type: string
            enum: [-created_at, created_at, price, -price]
          description: Сортировка: по дате (возр/убыв) или по цене (возр/убыв)
      responses:
        '200':
          description: Пагинированный список объявлений
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaginatedAdList'
              examples:
                page1:
                  value:
                    count: 1
                    next: null
                    previous: null
                    results:
                      - id: 1
                        title: "iPhone 13"
                        description: "Состояние отличное"
                        price: "699.00"
                        photos: []
                        location: "Москва"
                        contact: "+7 900 000-00-00"
                        condition: "like_new"
                        category_id: 2
                        owner_id: 10
                        is_favorite: false
                        created_at: "2025-10-01T12:00:00Z"
                        updated_at: "2025-10-02T12:00:00Z"
    post:
      tags: [Ads]
      summary: Создать объявление
      description: Доступно только авторизованным пользователям.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AdCreate'
            examples:
              sample:
                value:
                  title: "MacBook Air M2"
                  description: "Почти новый"
                  price: "999.99"
                  photos: ["https://example.com/1.jpg"]
                  location: "Санкт-Петербург"
                  contact: "+7 900 111-22-33"
                  condition: "like_new"
                  category_id: 3
      responses:
        '201':
          description: Объявление создано
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Ad'
        '400':
          description: Ошибка валидации
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
              examples:
                no_category:
                  value:
                    category_id: ["Указанная категория не найдена."]
        '401':
          description: Требуется авторизация
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorDetail'
              examples:
                no_auth:
                  value:
                    detail: "Требуется авторизация"
  /api/ads/{pk}:
    get:
      tags: [Ads]
      summary: Получить объявление
      description: Публичное получение одного объявления по ID.
      parameters:
        - in: path
          name: pk
          required: true
          schema: { type: integer }
          description: Идентификатор объявления
      responses:
        '200':
          description: Объявление
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Ad'
        '404':
          description: Не найдено
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorDetail'
              examples:
                not_found:
                  value:
                    detail: "Не найдено"
    put:
      tags: [Ads]
      summary: Обновить объявление
      description: Только владелец объявления. Требуется авторизация.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: pk
          required: true
          schema: { type: integer }
          description: Идентификатор объявления
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AdUpdate'
      responses:
        '200':
          description: Обновлённое объявление
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Ad'
        '400':
          description: Ошибка валидации
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '401':
          description: Требуется авторизация
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorDetail'
        '403':
          description: Нет прав (не владелец)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorDetail'
              examples:
                not_owner:
                  value:
                    detail: "Нет прав"
        '404':
          description: Не найдено
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorDetail'
    delete:
      tags: [Ads]
      summary: Удалить объявление
      description: Только владелец объявления. Требуется авторизация.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: pk
          required: true
          schema: { type: integer }
          description: Идентификатор объявления
      responses:
        '204':
          description: Удалено, без содержимого
        '401':
          description: Требуется авторизация
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorDetail'
        '403':
          description: Нет прав (не владелец)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorDetail'
        '404':
          description: Не найдено
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorDetail'
  /api/ads/{pk}/favorite:
    post:
      tags: [Ads]
      summary: Добавить в избранное
      description: Помечает объявление как избранное для текущего пользователя.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: pk
          required: true
          schema: { type: integer }
          description: Идентификатор объявления
      responses:
        '204':
          description: Добавлено в избранное (без содержимого)
        '401':
          description: Требуется авторизация
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorDetail'
        '404':
          description: Не найдено
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorDetail'
    delete:
      tags: [Ads]
      summary: Удалить из избранного
      description: Снимает отметку избранного для текущего пользователя.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: pk
          required: true
          schema: { type: integer }
          description: Идентификатор объявления
      responses:
        '204':
          description: Удалено из избранного (без содержимого)
        '401':
          description: Требуется авторизация
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorDetail'
        '404':
          description: Не найдено
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorDetail'
  /api/members/me/ads:
    get:
      tags: [Members]
      summary: Мои объявления
      description: Пагинированный список объявлений текущего пользователя.
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: page
          schema: { type: integer, minimum: 1 }
          description: Номер страницы
        - in: query
          name: page_size
          schema: { type: integer, minimum: 1, maximum: 200 }
          description: Размер страницы
      responses:
        '200':
          description: Пагинированный список объявлений
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaginatedAdList'
        '401':
          description: Требуется авторизация
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorDetail'
  /api/members/me/favorites:
    get:
      tags: [Members]
      summary: Мои избранные объявления
      description: Пагинированный список избранных объявлений текущего пользователя.
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: page
          schema: { type: integer, minimum: 1 }
          description: Номер страницы
        - in: query
          name: page_size
          schema: { type: integer, minimum: 1, maximum: 200 }
          description: Размер страницы
      responses:
        '200':
          description: Пагинированный список избранных объявлений
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaginatedAdList'
        '401':
          description: Требуется авторизация
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorDetail'
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    Message:
      type: object
      description: Простое сообщение с меткой времени
      properties:
        message:
          type: string
          description: Текст сообщения
        timestamp:
          type: string
          format: date-time
          description: Время формирования ответа (UTC)
      required: [message, timestamp]
    ErrorDetail:
      type: object
      description: Сообщение об ошибке
      properties:
        detail:
          type: string
          description: Текст ошибки
      required: [detail]
    ValidationError:
      type: object
      description: Ошибки валидации по полям
      additionalProperties:
        type: array
        items:
          type: string
      example:
        email: ["Введите корректный email."]
    Member:
      type: object
      description: Участник (профиль пользователя)
      properties:
        id:
          type: integer
          format: int64
          description: Уникальный идентификатор участника
          readOnly: true
        name:
          type: string
          description: Имя пользователя
        email:
          type: string
          format: email
          description: Электронная почта
        phone:
          type: string
          description: Телефон
        avatar_url:
          type: string
          description: URL аватара
        created_at:
          type: string
          format: date-time
          description: Дата создания профиля
          readOnly: true
      required: [id, name, email, phone, avatar_url, created_at]
    MemberUpdate:
      type: object
      description: Поля для обновления профиля
      properties:
        name:
          type: string
          description: Имя пользователя
        phone:
          type: string
          description: Телефон
        avatar_url:
          type: string
          description: URL аватара
    AuthRegisterRequest:
      type: object
      description: Данные для регистрации
      properties:
        name:
          type: string
          description: Имя пользователя
        email:
          type: string
          format: email
          description: Электронная почта
        phone:
          type: string
          description: Телефон
        password:
          type: string
          format: password
          minLength: 6
          description: Пароль
      required: [name, email, phone, password]
    AuthLoginRequest:
      type: object
      description: Данные для входа
      properties:
        email:
          type: string
          format: email
          description: Электронная почта
        password:
          type: string
          format: password
          description: Пароль
      required: [email, password]
    AuthTokenResponse:
      type: object
      description: Ответ с токеном доступа
      properties:
        access:
          type: string
          description: JWT токен доступа
        token_type:
          type: string
          description: Тип токена (всегда bearer)
          example: bearer
        expires_in:
          type: integer
          description: Время жизни токена в секундах
      required: [access, token_type, expires_in]
    Category:
      type: object
      description: Категория объявлений
      properties:
        id:
          type: integer
          format: int64
          description: Уникальный идентификатор категории
          readOnly: true
        name:
          type: string
          description: Название категории
        slug:
          type: string
          description: ЧПУ-идентификатор
        parent_id:
          type: integer
          format: int64
          nullable: true
          description: ID родительской категории (если есть)
      required: [id, name, slug]
    Ad:
      type: object
      description: Объявление
      properties:
        id:
          type: integer
          format: int64
          description: Уникальный идентификатор объявления
          readOnly: true
        title:
          type: string
          description: Заголовок
        description:
          type: string
          description: Описание
        price:
          type: string
          description: Цена (десятичное число, два знака после запятой)
        photos:
          type: array
          description: Список ссылок на фотографии (строки)
          items:
            type: string
        location:
          type: string
          description: Местоположение
        contact:
          type: string
          description: Контактные данные
        condition:
          type: string
          description: Состояние товара
          enum: [new, like_new, used, for_parts]
        category_id:
          type: integer
          format: int64
          description: ID категории
        owner_id:
          type: integer
          format: int64
          description: ID владельца объявления
          readOnly: true
        is_favorite:
          type: boolean
          description: Признак, что объявление в избранном у текущего пользователя
          readOnly: true
        created_at:
          type: string
          format: date-time
          description: Дата создания
          readOnly: true
        updated_at:
          type: string
          format: date-time
          description: Дата обновления
          readOnly: true
      required:
        - id
        - title
        - description
        - price
        - photos
        - location
        - contact
        - condition
        - category_id
        - owner_id
        - is_favorite
        - created_at
        - updated_at
    AdCreate:
      type: object
      description: Данные для создания объявления
      properties:
        title:
          type: string
          description: Заголовок
        description:
          type: string
          description: Описание
        price:
          type: string
          description: Цена (десятичное число)
        photos:
          type: array
          description: Список ссылок на фотографии (строки)
          items:
            type: string
        location:
          type: string
          description: Местоположение
        contact:
          type: string
          description: Контактные данные
        condition:
          type: string
          description: Состояние товара
          enum: [new, like_new, used, for_parts]
        category_id:
          type: integer
          format: int64
          description: ID категории
      required:
        - title
        - description
        - price
        - location
        - contact
        - condition
        - category_id
    AdUpdate:
      type: object
      description: Данные для обновления объявления (те же поля, что и при создании)
      properties:
        title:
          type: string
          description: Заголовок
        description:
          type: string
          description: Описание
        price:
          type: string
          description: Цена (десятичное число)
        photos:
          type: array
          description: Список ссылок на фотографии (строки)
          items:
            type: string
        location:
          type: string
          description: Местоположение
        contact:
          type: string
          description: Контактные данные
        condition:
          type: string
          description: Состояние товара
          enum: [new, like_new, used, for_parts]
        category_id:
          type: integer
          format: int64
          description: ID категории
    PaginatedAdList:
      type: object
      description: Пагинированный список объявлений
      properties:
        count:
          type: integer
          description: Общее число элементов
        next:
          type: string
          format: uri
          nullable: true
          description: URL следующей страницы или null
        previous:
          type: string
          format: uri
          nullable: true
          description: URL предыдущей страницы или null
        results:
          type: array
          description: Список объявлений на текущей странице
          items:
            $ref: '#/components/schemas/Ad'
      required: [count, next, previous, results]
